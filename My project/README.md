# Руководство по настройке проекта Unity

**Версия Unity:** 2022.3.49f1  
**Рендер-пайплайн:** Universal Render Pipeline 14.0.11

---

## Оглавление

1. [Система взаимодействия с предметами](#система-взаимодействия-с-предметами)
2. [Система движения игрока](#система-движения-игрока)
3. [Диалоговая система](#диалоговая-система)
4. [Система управления событиями](#система-управления-событиями)
5. [Блокировка ввода во время диалогов](#блокировка-ввода-во-время-диалогов)

---

## Система взаимодействия с предметами

### Обзор

Система взаимодействия позволяет игроку подбирать предметы, открывать двери и перетаскивать объекты, используя клавишу **E**.

### Структура скриптов

- **`Item.cs`** — компонент для объектов-предметов
- **`PickupItem.cs`** — основной скрипт обработки взаимодействия
- **`Inventory.cs`** — управление инвентарем игрока
- **`InteractionType.cs`** — перечисление типов взаимодействия

---

### 1. Скрипт `Item.cs`

#### Назначение
Компонент, который добавляется на каждый интерактивный объект в сцене (предметы, двери, объекты для перетаскивания).

#### Где крепить
Добавьте компонент `Item` на GameObject предмета в сцене.

#### Параметры в инспекторе

| Параметр | Тип | Описание |
|----------|-----|----------|
| **Item Name** | `string` | Название предмета (например, "Кольт", "Ключ", "Дверь") |
| **Item Icon** | `Sprite` | Иконка предмета для инвентаря (опционально) |
| **Interaction Type** | `InteractionType` | Тип взаимодействия: `Pickup`, `Door`, `Draggable` |
| **Hold Duration** | `float` | Время удержания клавиши E в секундах (для Door и Draggable) |

#### Типы взаимодействия

- **`Pickup`** — предмет подбирается мгновенно при нажатии E
- **`Door`** — требуется удержать E в течение `holdDuration` секунд для открытия
- **`Draggable`** — требуется удержать E в течение `holdDuration` секунд, затем предмет можно перетаскивать

#### Пример настройки

1. Создайте GameObject в сцене (например, куб или модель предмета)
2. Добавьте компонент `Collider` (BoxCollider, CapsuleCollider и т.д.)
3. Добавьте компонент `Item`
4. Заполните параметры:
   - `Item Name`: "Ключ"
   - `Interaction Type`: `Pickup`
   - `Hold Duration`: 0 (для Pickup не используется)

#### Важные замечания

- У предмета **обязательно** должен быть `Collider` (не обязательно `Is Trigger`)
- Компонент `Item` можно разместить на самом объекте, на родительском объекте или на дочернем объекте — скрипт `PickupItem` найдет его автоматически
- Для предметов типа `Door` и `Draggable` рекомендуется установить `Hold Duration` в диапазоне 1-3 секунды

---

### 2. Скрипт `PickupItem.cs`

#### Назначение
Основной скрипт, обрабатывающий взаимодействие игрока с предметами. Определяет предметы в радиусе действия, обрабатывает нажатие клавиши E и выполняет соответствующие действия.

#### Где крепить
**Добавьте компонент `PickupItem` на объект игрока (Player)** или на объект с камерой игрока.

#### Параметры в инспекторе

| Параметр | Тип | Описание | Значение по умолчанию |
|----------|-----|----------|----------------------|
| **Interaction Range** | `float` | Радиус обнаружения предметов в метрах | 3.0 |
| **Interact Key** | `KeyCode` | Клавиша для взаимодействия | `E` |
| **Drag Distance** | `float` | Расстояние перед камерой для перетаскиваемых предметов | 2.0 |
| **Interaction Layer Mask** | `LayerMask` | Фильтр слоев для обнаружения предметов | Все слои (-1) |

#### Требования

1. **Камера игрока** должна быть помечена как `Main Camera` (тег `MainCamera`)
2. **Объект с `Inventory`** должен существовать в сцене (см. раздел про Inventory)
3. Для работы с диалогами должен быть настроен `DialogueInputBlocker` (см. соответствующий раздел)

#### Как работает

1. **Обнаружение предметов:**
   - Скрипт использует `Physics.Raycast` от позиции камеры вперед
   - Если raycast не находит предмет, используется `Physics.OverlapSphere` для поиска в радиусе
   - Предметы должны быть в пределах угла обзора 90° от направления взгляда камеры

2. **Взаимодействие:**
   - **Pickup**: Мгновенное подбирание при нажатии E (до 10 метров)
   - **Door**: Удержание E в течение `holdDuration` секунд для открытия
   - **Draggable**: Удержание E в течение `holdDuration` секунд, затем предмет прикрепляется к камере и следует за ней

3. **Перетаскивание:**
   - Перетаскиваемый предмет временно становится дочерним объектом камеры
   - Физика предмета отключается (`isKinematic = true`)
   - Коллайдер предмета отключается, чтобы не мешать лучу
   - При отпускании E предмет бросается с небольшим импульсом вперед

#### Пример настройки

1. Выберите объект `Player` в сцене
2. Добавьте компонент `PickupItem`
3. Настройте параметры:
   - `Interaction Range`: 3 (для ближнего взаимодействия) или 5-10 (для дальнего)
   - `Interact Key`: `E` (или любая другая клавиша)
   - `Drag Distance`: 2 (расстояние перед камерой при перетаскивании)

#### Важные замечания

- Скрипт автоматически ищет `Camera.main` и `Inventory` в сцене
- Если предмет находится дальше `interactionRange`, но виден игроку (в пределах 90°), он все равно может быть обнаружен
- Для предметов типа `Pickup` максимальная дистанция взаимодействия увеличена до 10 метров
- Во время диалогов взаимодействие автоматически блокируется (через `DialogueInputBlocker`)

---

### 3. Скрипт `Inventory.cs`

#### Назначение
Управляет инвентарем игрока: хранит список подобранных предметов и предоставляет методы для проверки наличия предметов.

#### Где крепить
**Добавьте компонент `Inventory` на объект игрока (Player)** или на любой другой GameObject, который должен существовать в течение всей игры.

#### Параметры в инспекторе

| Параметр | Тип | Описание |
|----------|-----|----------|
| **Inventory Items** | `List<ItemData>` | Список предметов в инвентаре (заполняется автоматически) |

#### Публичные методы

- **`AddItem(Item item)`** — добавляет предмет в инвентарь (вызывается автоматически из `PickupItem`)
- **`HasItem(string itemName)`** — проверяет наличие предмета по имени
- **`HasColt()`** — специальный метод для проверки наличия кольта (проверяет варианты: "кольт", "Кольт", "colt", "Colt")

#### Пример использования в коде

```csharp
// Проверка наличия предмета
if (playerInventory.HasItem("Ключ"))
{
    Debug.Log("У игрока есть ключ!");
}

// Проверка наличия кольта
if (playerInventory.HasColt())
{
    Debug.Log("У игрока есть кольт!");
}
```

#### Пример настройки

1. Выберите объект `Player` в сцене
2. Добавьте компонент `Inventory`
3. Параметры заполняются автоматически при подборе предметов

#### Важные замечания

- Инвентарь хранит только данные предметов (`ItemData`), а не сами GameObject
- После подбора предмет его GameObject уничтожается из сцены
- Если нужна персистентность инвентаря между сценами, сохраните объект с `Inventory` через `DontDestroyOnLoad`

---

### 4. Типы взаимодействия (`InteractionType.cs`)

Перечисление содержит три типа:

- **`Pickup`** — подбираемый предмет (мгновенное взаимодействие)
- **`Door`** — дверь (требует удержания E)
- **`Draggable`** — перетаскиваемый предмет (требует удержания E, затем перетаскивание)

---

## Полная настройка системы взаимодействия (пошагово)

### Шаг 1: Настройка игрока

1. Создайте или выберите объект `Player` в сцене
2. Добавьте компонент `Inventory` на объект `Player`
3. Добавьте компонент `PickupItem` на объект `Player`
4. Убедитесь, что камера игрока помечена как `Main Camera`

### Шаг 2: Создание предмета для подбора

1. Создайте GameObject (например, куб или модель)
2. Добавьте `Collider` (BoxCollider, CapsuleCollider и т.д.)
3. Добавьте компонент `Item`
4. Настройте `Item`:
   - `Item Name`: "Ключ"
   - `Interaction Type`: `Pickup`
   - `Item Icon`: (опционально) перетащите спрайт иконки

### Шаг 3: Создание двери

1. Создайте GameObject двери
2. Добавьте `Collider`
3. Добавьте компонент `Item`
4. Настройте `Item`:
   - `Item Name`: "Дверь"
   - `Interaction Type`: `Door`
   - `Hold Duration`: 2.0 (секунды удержания E)

### Шаг 4: Создание перетаскиваемого предмета

1. Создайте GameObject (например, коробка)
2. Добавьте `Collider`
3. Добавьте `Rigidbody` (опционально, для физики при броске)
4. Добавьте компонент `Item`
5. Настройте `Item`:
   - `Item Name`: "Коробка"
   - `Interaction Type`: `Draggable`
   - `Hold Duration`: 1.5 (секунды удержания E)

### Шаг 5: Тестирование

1. Запустите сцену (Play)
2. Подойдите к предмету и нажмите **E**
3. Для дверей и перетаскиваемых предметов удерживайте **E** необходимое время

---

## Система движения игрока

### Обзор

Система движения обеспечивает управление игроком: ходьба, бег, прыжки, приседание и управление камерой.

### Структура скриптов

- **`PlayerMovement.cs`** — управление движением и физикой
- **`MouseLook.cs`** — управление камерой (вращение по мыши)

---

### 1. Скрипт `PlayerMovement.cs`

#### Назначение
Управляет движением игрока, прыжками, приседанием и взаимодействием с физикой.

#### Где крепить
**Добавьте компонент `PlayerMovement` на объект игрока (Player)**.

#### Требования

- Объект должен иметь компонент `CharacterController`
- Если есть камера, она должна быть дочерним объектом или назначена в поле `Camera Transform`

#### Параметры в инспекторе

| Группа | Параметр | Тип | Описание | По умолчанию |
|--------|----------|-----|----------|--------------|
| **Speed Settings** | Walk Speed | `float` | Скорость ходьбы | 4.0 |
| | Run Speed | `float` | Скорость бега | 8.0 |
| | Crouch Speed Multiplier | `float` | Множитель скорости при приседе | 0.5 |
| | Gravity | `float` | Сила гравитации | -20.0 |
| | Jump Height | `float` | Высота прыжка | 1.6 |
| **Movement Settings** | Acceleration | `float` | Ускорение | 50.0 |
| | Deceleration | `float` | Замедление | 60.0 |
| | Air Control | `float` | Контроль в воздухе (0-1) | 0.3 |
| **Camera Settings** | Camera Transform | `Transform` | Ссылка на камеру | Автопоиск |
| | Camera Stand Height | `float` | Высота камеры стоя | 1.6 |
| | Camera Crouch Height | `float` | Высота камеры при приседе | 1.0 |
| | Camera Transition Speed | `float` | Скорость изменения высоты камеры | 5.0 |
| **Ground Check** | Ground Mask | `LayerMask` | Слои для определения земли | Все |
| | Ground Check Distance | `float` | Дистанция проверки земли | 0.2 |
| | Stand Height | `float` | Высота CharacterController стоя | 2.0 |
| | Crouch Height | `float` | Высота CharacterController при приседе | 1.2 |

#### Управление

- **WASD / Стрелки** — движение
- **Left Shift / Right Shift** — бег
- **Left Control / Right Control** — приседание
- **Space** — прыжок

#### Пример настройки

1. Создайте объект `Player`
2. Добавьте компонент `CharacterController`
3. Добавьте компонент `PlayerMovement`
4. Настройте `CharacterController`:
   - `Height`: 2.0
   - `Radius`: 0.5
   - `Center`: (0, 1, 0)
5. Если есть камера, перетащите её в поле `Camera Transform`

---

### 2. Скрипт `MouseLook.cs`

#### Назначение
Управляет вращением камеры по движению мыши (ось X и Y).

#### Где крепить
**Добавьте компонент `MouseLook` на объект камеры игрока**.

#### Параметры в инспекторе

| Параметр | Тип | Описание | По умолчанию |
|----------|-----|----------|--------------|
| **Player Body** | `Transform` | Ссылка на тело игрока (для горизонтального вращения) | Обязательно |
| **Mouse Sensitivity** | `float` | Чувствительность мыши | 100.0 |
| **Min Pitch** | `float` | Минимальный угол наклона камеры (вверх) | -90.0 |
| **Max Pitch** | `float` | Максимальный угол наклона камеры (вниз) | 90.0 |

#### Пример настройки

1. Создайте дочерний объект камеры под `Player` (например, `Camera` или `Main Camera`)
2. Добавьте компонент `MouseLook` на камеру
3. Перетащите объект `Player` в поле `Player Body`
4. Настройте чувствительность по желанию

#### Важные замечания

- Курсор автоматически блокируется при старте (`CursorLockMode.Locked`)
- Вращение камеры блокируется во время диалогов (через `DialogueInputBlocker`)
- Скрипт триггерит событие `OnMouseMoved` в `EventManager` при первом движении мыши

---

## Диалоговая система

### Обзор

Система диалогов позволяет создавать интерактивные диалоги с тайпрайтером, звуком печати и управлением событиями.

### Основные скрипты

- **`DialogueManager.cs`** — управление диалогами
- **`DialogueUIBinder.cs`** — привязка UI к диалогам
- **`TriggerZone.cs`** — триггеры для запуска диалогов
- **`DialogueTypes.cs`** — структуры данных

### Подробная инструкция

Для полной инструкции по настройке диалоговой системы см. файл **`README_RU.md`** в корне проекта.

**Краткий обзор:**

1. Создайте объект `Systems` в первой сцене
2. Добавьте компоненты: `DialogueManager`, `AudioManager`, `GameManager`, `SceneLoader`
3. Создайте UI для диалогов (Canvas с панелью и текстами)
4. Добавьте `DialogueUIBinder` для автоматической привязки
5. Создайте JSON-файлы диалогов в `Assets/Resources/Dialogues/`
6. Используйте `TriggerZone` для запуска диалогов при входе игрока

---

## Система управления событиями

### Скрипт `EventManager.cs`

#### Назначение
Централизованная система событий для связи между различными системами игры.

#### Где крепить
**Добавьте компонент `EventManager` на объект `Systems`** (в первой сцене). Скрипт использует паттерн Singleton и автоматически сохраняется между сценами (`DontDestroyOnLoad`).

#### Доступные события

- `OnObjectPickedUp` / `OnObjectPickedUpWithName(string)` — предмет подобран
- `OnDoorOpened` — дверь открыта
- `OnWeaponDrawn` — оружие вынуто
- `OnWeaponFired` — произведен выстрел
- `OnMouseMoved` — мышь двинулась
- `OnKeyPressed` / `OnKeyPressedWithName(string)` — нажата клавиша
- `OnObjectDestroyedByShot(string)` — объект уничтожен выстрелом
- `OnTargetHit` — попадание в цель

#### Пример использования в коде

```csharp
using Systems;

// Подписка на событие
void Start()
{
    if (EventManager.Instance != null)
    {
        EventManager.Instance.OnObjectPickedUpWithName.AddListener(OnItemPickedUp);
    }
}

void OnItemPickedUp(string itemName)
{
    Debug.Log($"Подобран предмет: {itemName}");
}

// Отписка
void OnDestroy()
{
    if (EventManager.Instance != null)
    {
        EventManager.Instance.OnObjectPickedUpWithName.RemoveListener(OnItemPickedUp);
    }
}
```

#### Пример настройки

1. Создайте объект `Systems` в первой сцене
2. Добавьте компонент `EventManager`
3. Скрипт автоматически становится `Instance` и сохраняется между сценами

---

## Блокировка ввода во время диалогов

### Скрипт `DialogueInputBlocker.cs`

#### Назначение
Автоматически блокирует управление игроком (движение, камера, взаимодействие) во время активного диалога.

#### Где крепить
**Добавьте компонент `DialogueInputBlocker` на объект игрока (Player)**.

#### Параметры в инспекторе

| Параметр | Тип | Описание |
|----------|-----|----------|
| **Auto Find Components** | `bool` | Автоматически искать компоненты на игроке | true |
| **Player Movement** | `PlayerMovement` | Ссылка на скрипт движения (если автопоиск выключен) | Автопоиск |
| **Mouse Look** | `MonoBehaviour` | Ссылка на скрипт управления камерой (если автопоиск выключен) | Автопоиск |
| **Additional Components** | `List<MonoBehaviour>` | Дополнительные компоненты для блокировки | Пусто |

#### Как работает

1. При старте диалога (`DialogueManager.OnDialogueStarted`):
   - Блокируется статический флаг `IsInputBlocked = true`
   - Отключаются компоненты `PlayerMovement` и `MouseLook`
   - Останавливается движение через `CharacterController.Move(Vector3.zero)`

2. При окончании диалога (`DialogueManager.OnDialogueFinished`):
   - Снимается блокировка `IsInputBlocked = false`
   - Включаются компоненты обратно

3. Скрипты, которые проверяют `DialogueInputBlocker.IsInputBlocked`:
   - `PickupItem` — блокирует взаимодействие
   - `MouseLook` — блокирует вращение камеры
   - `PlayerMovement` — может быть расширен для блокировки движения

#### Пример настройки

1. Выберите объект `Player` в сцене
2. Добавьте компонент `DialogueInputBlocker`
3. Оставьте `Auto Find Components` включенным (по умолчанию)
4. Скрипт автоматически найдет `PlayerMovement` и `MouseLook`

#### Важные замечания

- Скрипт автоматически регистрируется на события `DialogueManager` при старте
- Если `DialogueManager` еще не создан, скрипт попытается зарегистрироваться позже
- Для проверки блокировки в других скриптах используйте: `Systems.DialogueInputBlocker.IsInputBlocked`

---

## Частые проблемы и решения

### Проблема: Взаимодействие с предметами не работает

**Решения:**
1. ✅ Убедитесь, что `PickupItem` добавлен на объект игрока
2. ✅ Проверьте, что камера помечена как `Main Camera`
3. ✅ Убедитесь, что `Inventory` добавлен на игрока или существует в сцене
4. ✅ Проверьте, что у предмета есть `Collider` и компонент `Item`
5. ✅ Проверьте, что предмет находится в пределах `Interaction Range` или в радиусе 10 метров для `Pickup`
6. ✅ Проверьте, что предмет находится в пределах угла обзора 90° от направления взгляда камеры
7. ✅ Убедитесь, что во время диалогов взаимодействие блокируется — это нормальное поведение

### Проблема: Предмет не обнаруживается

**Решения:**
1. ✅ Увеличьте `Interaction Range` в `PickupItem`
2. ✅ Посмотрите на предмет камерой (должен быть в пределах 90°)
3. ✅ Проверьте `Interaction Layer Mask` — предмет должен быть на разрешенном слое
4. ✅ Убедитесь, что коллайдер предмета не является триггером (или настройте LayerMask соответственно)

### Проблема: Предмет подбирается, но не добавляется в инвентарь

**Решения:**
1. ✅ Убедитесь, что компонент `Inventory` существует в сцене
2. ✅ Проверьте консоль Unity на наличие ошибок
3. ✅ Убедитесь, что `PickupItem` может найти `Inventory` (он должен быть в сцене)

### Проблема: Игрок проваливается через пол

**Решения:**
1. ✅ У пола должен быть `Collider` (не триггер)
2. ✅ На игроке должен быть `CharacterController` (не `Rigidbody`)
3. ✅ Проверьте `Ground Mask` в `PlayerMovement`
4. ✅ Убедитесь, что позиция спавна игрока не внутри пола

### Проблема: Камера не вращается

**Решения:**
1. ✅ Убедитесь, что `MouseLook` добавлен на камеру
2. ✅ Проверьте, что поле `Player Body` заполнено
3. ✅ Проверьте, что `DialogueInputBlocker` не блокирует ввод (если диалог активен)
4. ✅ Проверьте чувствительность мыши (`Mouse Sensitivity`)

### Проблема: Движение не работает

**Решения:**
1. ✅ Убедитесь, что `PlayerMovement` добавлен на игрока
2. ✅ Проверьте, что есть компонент `CharacterController`
3. ✅ Проверьте, что `DialogueInputBlocker` не блокирует ввод
4. ✅ Проверьте настройки скорости (`Walk Speed`, `Run Speed`)

---

## Рекомендуемая структура сцены

```
Scene
├── Systems (GameObject)
│   ├── GameManager
│   ├── SceneLoader
│   ├── DialogueManager
│   ├── AudioManager
│   └── EventManager
├── Player (GameObject)
│   ├── CharacterController
│   ├── PlayerMovement
│   ├── Inventory
│   ├── PickupItem
│   └── DialogueInputBlocker
│   └── Camera (Main Camera)
│       └── MouseLook
├── Canvas (UI)
│   └── DialoguePanel
│       ├── SpeakerText (TMP_Text)
│       ├── BodyText (TMP_Text)
│       └── DialogueUIBinder
└── Items (GameObjects)
    ├── Key (с компонентом Item)
    ├── Door (с компонентом Item)
    └── Box (с компонентом Item, Draggable)
```

---

## Связанные файлы и документация

- **`README_RU.md`** — подробная инструкция по диалоговой системе
- **`Assets/Scripts/System/DIALOGUE_SYSTEM_README.md`** — дополнительная документация по диалогам
- **`Assets/Scripts/Interact/Readme`** — краткое описание системы взаимодействия

---

## Контакты и поддержка

При возникновении проблем проверьте:
1. Консоль Unity (`Window → General → Console`)
2. Правильность настройки компонентов согласно этой инструкции
3. Существование всех необходимых объектов в сцене

---

**Последнее обновление:** 2024

